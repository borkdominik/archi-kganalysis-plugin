<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <style type="text/css">
        html, body {
            font: 16pt arial;
        }

        #panel-right {

        }

        #viz {
            height: 600px;
            border: 1px solid lightgray;
            font: 22pt arial;
        }

    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

	<title>Knowledge Graph</title>

	<!-- neovis.js Configuration -->
    <script type="text/javascript">
    	var viz;

    	function draw() {
			var config = {
				container_id: "viz",
				server_url: "bolt://localhost:7687",
				labels: {
					"elements": {
						"caption": "name",
						"size": "score",
						"community": "community"
					}
				},
				relationships: {
					"relationships": {
						"thickness": "count",
						"caption": false
					}
				},
				initial_cypher: "MATCH (n)-[r]-(m) RETURN n,r,m",
				arrows: true,
			};

			viz = new NeoVis.default(config);
			viz.render();
			console.log(viz);
		}

		
    </script>
</head>
<body onload="draw()">
	<div class="container-fluid">
		<div class="row">
			
			<!-- Left Panel -->
			<div class="col-8 mt-2">
				<div id="viz"></div>
    		</div>

    		<!-- Right Panel -->
    		<div class="col-4 mt-2">
    			<div class="accordion" id="right-panel">
  					
    				<!-- EA Smell Detection -->
  					<div class="accordion-item">
    					<h2 class="accordion-header" id="smell-header">
      						<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#smell-collapse" aria-expanded="true" aria-controls="smell-collapse">
        						EA Smell Detection
      						</button>
    					</h2>
    					<div id="smell-collapse" class="accordion-collapse collapse show" aria-labelledby="smell-header">
      						<div class="accordion-body">
      							<div class="input-group">
  									<select class="form-select mb-3" aria-label="Select Smell" id="smell-select" >
  										

									</select>
								</div>
								<button class="btn btn-primary" type="button" id="detect-smell">Detect</button>
      						</div>
    					</div>
  					</div>

  					<!-- Cypher Query -->
  					<div class="accordion-item">
						<h2 class="accordion-header" id="cypher-header">
      						<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cypher-collapse" aria-expanded="true" aria-controls="cypher-collapse">
        						Cypher Query
      						</button>
    					</h2>
    					<div id="cypher-collapse" class="accordion-collapse collapse" aria-labelledby="cypher-header">
      						<div class="accordion-body">
      							<textarea class="form-control mb-3" id="inputCypher" rows="3">MATCH (n)-[r]-(m) RETURN *</textarea>
								<button class="btn btn-secondary" type="button" id="reload">Execute Query</button>
      						</div>
    					</div>
  					</div>

  					<!-- Graph Options -->
  					<div class="accordion-item">
						<h2 class="accordion-header" id="options-header">
      						<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#options-collapse" aria-expanded="true" aria-controls="options-collapse">
        						Graph Options
      						</button>
    					</h2>
    					<div id="options-collapse" class="accordion-collapse collapse" aria-labelledby="options-header">
      						<div class="accordion-body">
      							<label for="scoreSelect" class="col-sm-6 col-form-label">Score</label>
    								<select class="form-select mb-2" id="scoreSelect" aria-label="Score">
    									<option selected value="pagerank">Page Rank</option>
  										<option value="degree">Degree</option>
  										<option value="2">Eigen Vector</option>
  										<option value="3">Betweenness</option>
  										<option value="4">Closeness</option>
									</select>
								<label for="communitySelect" class="col-sm-6 col-form-label">Community</label>
									<select class="form-select mb-2" id="communitySelect" aria-label="Community">
  										<option selected>Louvain</option>
  										<option value="1">Modularity Optimization</option>
  										<option value="2">Label Propagation</option>
  										<option value="3">Local Clustering Coefficient</option>
									</select>
							</div>
    					</div>
  					</div>
  				</div>
  			</div>
		</div>
	</div>

	<!-- Javascript -->
	<!-- JQuery and Bootstrap -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>


    <!-- neovis.js and neo4j driver -->
	<script src="https://cdn.neo4jlabs.com/neovis.js/v1.5.0/neovis.js"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
</body>

<script>
	//var driver = neo4j.driver( 'bolt://localhost:7687', neo4j.auth.basic('neo4j', 'admin') );

	$('#scoreSelect').on('change', function () {
			if (this.value === "pagerank") {
				setPageRank();
				viz.reload();
			} else if (this.value === "degree") {
				setDegree();
				viz.reload();
			}
		});

	$("#reload").click(function() {
		var cypher = $("#inputCypher").val();

		if (cypher.length > 3) {
			viz.renderWithCypher(cypher);
		} else {
			console.log("reload");
			viz.reload();
		}
	});

	$("#stabilize").click(function() {
		viz.stabilize();
	});



var smells =
[
 	{
    	"text"  : "No selection",
    	"value" : "1",
    	"selected" : true,
    	"query" : "MATCH (n)-[r]-(m) RETURN n,r,m",
    	"description" : "No smell selected. Showing all elements."
  	},
  	{
    	"text"     : "Dead Component",
    	"value"    : "2",
    	"query" : "MATCH (n) WHERE size((n)--())=0 return n",
    	"description" : "A component is no longer used or used to support potential future behavior."
	},
  	{
    	"text"  : "Cyclic Dependency",
    	"value" : "3",
    	"query" : "MATCH (a)-[r1]->(b)-[r2]->(c)-[]->(a) return *",
    	"description" : "Two or more abstractions directly or indirectly depend on each other"
  	},
  	{
    	"text"  : "Documentation",
    	"value" : "4",
    	"query" : "MATCH (n) WHERE size(n.documentation)>256 RETURN n",
    	"description" : "A lengthy documentation often points to unnecessary complex structures"
  	},
  	{
    	"text"  : "Dense Structure",
    	"value" : "5",
    	"query" : "MATCH (p) RETURN CASE WHEN avg(apoc.node.degree(p))>1.75 THEN 1 ELSE 0 END AS result",
    	"description" : "An EA repository has dense dependencies without any particular structure."
  	}
];

var selectBox = document.getElementById('smell-select');

for(var i = 0, l = smells.length; i < l; i++){
  var smell = smells[i];
  selectBox.options.add( new Option(smell.text, smell.value, smell.selected) );
}

$("#detect-smell").click(function() {
		const index = $('#smell-select').prop('selectedIndex');
		const query = smells[index].query;
		$("#inputCypher").val(query);
		viz.renderWithCypher(query);

	});


</script>
</html>

