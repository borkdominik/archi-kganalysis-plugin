<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CSS -->
  <style type="text/css">
    .main-container {
      height: 100vh;
    }

    #toolbar {
      min-height: 64px;
    }

    #collapseExample {
      z-index: 9999;
    }
    #leftPanel {
      border-right: 1px solid gray;
    }
    #viz {
      background-color: #d5fefd;
      background-image: linear-gradient(315deg, #d5fefd 0%, #fffcff 74%);
      height: calc(100vh - 70px);
      border: 1px solid black;
      border-radius: 10px;
    }
    div.vis-network div.vis-navigation div.vis-button.vis-up, 
    div.vis-network div.vis-navigation div.vis-button.vis-down, 
    div.vis-network div.vis-navigation div.vis-button.vis-left, 
    div.vis-network div.vis-navigation div.vis-button.vis-right, 
    div.vis-network div.vis-navigation div.vis-button.vis-zoomIn, 
    div.vis-network div.vis-navigation div.vis-button.vis-zoomOut, 
    div.vis-network div.vis-navigation div.vis-button.vis-zoomExtends {
      background-image: none !important;
    }
    div.vis-network div.vis-navigation div.vis-button:hover {
      box-shadow: none !important;
    }
    .vis-button:after {
      font-size: 2em;
      color: gray;
    }
    .vis-button:hover:after {
      font-size: 2em;
      color: lightgray;
    }
    .vis-button.vis-up:after {
      content: "▲";
    }
    .vis-button.vis-down:after {
      content: "▼";
    }
    .vis-button.vis-left:after {
      content: "◀";
    }
    .vis-button.vis-right:after {
      content: "▶";
    }
    .vis-button.vis-zoomIn:after {
      content: "+";
      font-weight: bold;
    }
    .vis-button.vis-zoomOut:after {
      content: "−";
      font-weight: bold;
    }
    .vis-button.vis-zoomExtends:after {
      content: "⤧";
    }
  </style>
  <!-- Bootstrap v4.6 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.6.1/dist/yeti/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <!-- Smells file -->
  <script type="text/javascript" src="smells.js"></script>
  <title>Knowledge Graph</title>
  <script type="text/javascript">
    var viz;
    // reusable vis.js config
    const defaultVisConfig = {
      nodes: {
        font: { size: 22, face: 'Tahoma', strokeWidth: 3, vadjust: -12 },
        labelHighlightBold: true,
        opacity: 0.8,
        shadow: { enabled: true, size: 20 },
        shape: "dot",
        widthConstraint: { maximum: 160 },
      },  
      edges: {
        arrows: { 
          to: { enabled: true, scaleFactor: 1.5 }, 
        },
        arrowStrikethrough: false,
        color: { inherit: 'both', opacity: 0.5 },
        font: { align: 'top' },
        hoverWidth: 5.0,
        //shadow: { enabled: true },
        smooth: { type: "continuous", forceDirection: "none" },
        width: 3.0
      },
      layout: { 
        improvedLayout: true
      },
      interaction: { 
        hover: true, 
        navigationButtons: true, 
        keyboard: true 
      },
      physics: {
        stabilization: { enabled: true, fit: true },
        solver: "forceAtlas2Based",
        forceAtlas2Based: {
          theta: 0.5,
          gravitationalConstant: -150,
          centralGravity: 0.015,
          springConstant: 0.08,
          springLength: 100,
          damping: 0.5,
          avoidOverlap: 0.8
        }
      }
    };

    // draws the initial graph
    function draw() {
      var config = {
        containerId: "viz",
        neo4j: { serverUrl: "bolt://localhost:7687" },
        initialCypher: $("#cypher").val(),
        labels: {
          [NeoVis.NEOVIS_DEFAULT_CONFIG]: {
            label: "name",
            color: "color",
            value: $("#node-size input[type='radio']:checked").val(), 
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: { 
                title: (props) => NeoVis.objectToTitleHtml(props, ["name", "class", "layer", "aspect"]),
              },
            }
          }
        },
        relationships: {
          "RELATIONSHIP": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: {
                title: (props) => NeoVis.objectToTitleHtml(props, ["name", "type"])
              }
            }
          }  
        },
        visConfig: defaultVisConfig
      };
      viz = new NeoVis.default(config);
      viz.render();
    }

    function drawCommunites() {
      var config = {
        containerId: "viz",
        neo4j: { serverUrl: "bolt://localhost:7687" },
        initialCypher: $("#cypher").val(),

        labels: {
          [NeoVis.NEOVIS_DEFAULT_CONFIG]: {
            label: "name",
            group: $("#community-color input[type='radio']:checked").val(),
            value: $("#node-size input[type='radio']:checked").val(), 
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: { 
                title: (props) => NeoVis.objectToTitleHtml(props, ["name", "class", "layer", "aspect"]),
              },
            }
          }
        },
        relationships: {
          "RELATIONSHIP": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: {
                title: (props) => NeoVis.objectToTitleHtml(props, ["name", "type"])
              }
            }
          }  
        },
        visConfig: defaultVisConfig
      };
      viz = new NeoVis.default(config);
      viz.render();
    }

    function drawSmells() {
      var smellConfig = {
        containerId: "viz",
        neo4j: { serverUrl: "bolt://localhost:7687" },
        initialCypher: $("#cypher").val(),//"MATCH (n) OPTIONAL MATCH (n)-[r]->(m) RETURN n, r, m",
        labels: {
          [NeoVis.NEOVIS_DEFAULT_CONFIG]: {
            label: "name",
            color: "color",
            value: $("#node-size input[type='radio']:checked").val(), 
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: { 
                title: (props) => NeoVis.objectToTitleHtml(props, ["name", "class", "layer", "aspect"]),
              }
            }
          },
          "Smell": {
            value: $("#node-size input[type='radio']:checked").val(),
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
                /*TODO: smell info - function: { 
                  title: (props) => NeoVis.objectToTitleHtml(props, ["name"])
                },*/
                static: {
                  borderWidth: 2,
                  color: '#F08080',
                }
              },
            },
          },
          relationships: {
            "RELATIONSHIP": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: { // same as label advance function
                title: NeoVis.objectToTitleHtml
              }
            }
          },
          "DUPLICATION": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              function: { // same as label advance function
                title: NeoVis.objectToTitleHtml
              },
              static: { 
                label: "DUPLICATION",
                dashes: true,
                color: 'red',
              }  
            }
          },
          "CYCLIC_DEPENDENCY": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              static: { 
                label: "CYCLIC_DEPENDENCY",
                dashes: true,
                color: 'red'
              }  
            }
          },
          "STRICT_LAYER_VIOLATION": {
            [NeoVis.NEOVIS_ADVANCED_CONFIG]: {
              static: { 
                label: "STRICT_LAYER_VIOLATION",
                dashes: true,
                color: 'red'
              }  
            }
          }
        },
        visConfig: defaultVisConfig
      };
      viz = new NeoVis.default(smellConfig);
      viz.render();
    }
</script>
</head>
<body onload="draw()">
 <div class="container-fluid main-container">
  <div class="row panel-row">

   <!-- Left Panel -->
   <div class="col-8" id="leftPanel">
    <div id="toolbar">
      <div class="row">
        <button class="btn btn-primary btn-sm mt-3 mr-5 ml-5" type="button" data-toggle="collapse" data-target="#queryCollapse" aria-expanded="false" aria-controls="queryCollapse">Cypher Query <i class="bi bi-caret-down"></i> </button>
        <button class="btn btn-success btn-sm mt-3 ml-5 mr-2" type="submit" id="getAll">Show Graph</button>
        <button class="btn btn-secondary btn-sm mt-3 mr-2" type="submit" id="stabilize">Stabilize Layout</button>
        <button class="btn btn-warning btn-sm mt-3" type="submit" id="smellDetection">Show Smells</button>
      </div>
      <div class="collapse" id="queryCollapse">
        <div class="card card-body mt-3 mb-3 mr-2 ml-2">
          <textarea class="form-control mb-2" id="cypher" rows="2">MATCH (n) OPTIONAL MATCH (n)-[r:RELATIONSHIP]->(m) RETURN n, r, m</textarea>
          <button class="btn btn-danger btn-sm" type="submit" id="reload">Execute Query</button>
        </div>
      </div>
    </div>
    <!-- neovis visualization -->
    <div id="viz"></div>
  </div>

  <!-- Right Panel -->
  <div class="col-4 mt-2 justify-content-between">
    <ul class="nav nav-pills mb-3 nav-justified" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="general-container-tab" data-toggle="pill" href="#general-tab" role="tab" aria-controls="general-tab" aria-selected="true">General</a>
      </li>
      <li class="nav-item" role="presentation" id="smells-tab">
        <a class="nav-link" id="smells-container-tab" data-toggle="pill" href="#smells-container" role="tab" aria-controls="smells-container" aria-selected="false">EA Smells</a>
      </li>
    </ul>
    <hr>
    <div class="tab-content mb-5" id="pills-tabContent">

      <!-- General Tab -->
      <div class="tab-pane fade show active" id="general-tab" role="tabpanel" aria-labelledby="general-container-tab">
        <!-- Filters -->
        <h5 class="mt-4"><i class="bi bi-filter"></i> Filters</h5>
        <h6 class="text-muted">Layer</h6>
        <form id="layers-form">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="strategyCheck" value="layer='strategy'" checked>
            <label class="form-check-label" for="strategyCheck">Strategy</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="businessCheck" value="layer='business'" checked>
            <label class="form-check-label" for="businessCheck">Business</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="applicationCheck" value="layer='application'" checked>
            <label class="form-check-label" for="applicationCheck">Application</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="technologyCheck" value="layer='technology'" checked>
            <label class="form-check-label" for="technologyCheck">Technology</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="implementationMigrationCheck" value="layer='implementation_migration'" checked>
            <label class="form-check-label" for="implementationMigrationheck">Implementation & Migration</label>
          </div>
        </form>
        <h6 class="text-muted mt-2">Aspect</h6>
        <form id="aspect-form">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="activeCheck" value="aspect='active structure'" checked>
            <label class="form-check-label" for="activeCheck">Active Structure</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="passiveCheck" value="aspect='passive structure'" checked>
            <label class="form-check-label" for="passiveCheck">Passive structure</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="behaviourCheck" value="aspect='behaviour'" checked>
            <label class="form-check-label" for="behaviourCheck">Behaviour</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="motivationCheck" value="aspect='motivation'" checked>
            <label class="form-check-label" for="motivationCheck">Motivation</label>
          </div>
        </form>
        <button class="btn btn-info btn-sm mt-2 mb-2" type="submit" id="apply">Apply</button>
        <hr>

        <!-- Options -->
        <h5 class="mt-3"><i class="bi bi-sliders"></i> Options</h5>
        <h6 class="text-muted">Node Size</h6>
        <form id="node-size">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="defaultSize" value="20.0" checked>
            <label class="form-check-label" for="defaultSize">No algorithm</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="pagerank" value="pageRank">
            <label class="form-check-label" for="pageRank">Page Rank</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="degree" value="degree">
            <label class="form-check-label" for="degree">Degree</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="betweenness" value="betweenness">
            <label class="form-check-label" for="inlineRadio3">Betweenness</label>
          </div>
        </form>
        <h6 class="text-muted mt-2">Community Color</h6>
        <form id="community-color">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="archimate" value="color" checked>
            <label class="form-check-label" for="archimate">ArchiMate</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="louvain" value="louvain">
            <label class="form-check-label" for="louvain">Louvain</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="labelPropagation" value="labelPropagation">
            <label class="form-check-label" for="labelPropagation">Label Propagation</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="wcc" value="wcc">
            <label class="form-check-label" for="wcc">Weakly Connected Components</label>
          </div>
        </form>
        <button class="btn btn-info btn-sm mt-2" type="submit" id="save">Save</button>
      </div>

      <!-- Smells Tab -->
      <div class="tab-pane fade" id="smells-container" role="tabpanel">
        <div id="smellInfo">
          <h5 class="mb-3"><i class="bi bi-info-circle"></i> Info</h5>
          <h6 id="smellName">No smell selected.</h6>
          <p id="smellDescription"></p>
          <p id="smellSolution" class="mb-5"></p>
        </div>
        <hr>
        <h5><i class="bi bi-card-list"></i> Smells</h5>
        <div class="list-group mt-3" id="smells-list"></div>
      </div>

    </div>
  </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<script src="https://unpkg.com/neovis.js@2.0.0-alpha.9"></script>
</body>

<script>
  $(document).ready(function() {
    // Update EA Smells tab with data from smells.js
    smells.forEach(function(currentValue, index) {
      var $card = $("<div>", {class: "list-group-item d-flex justify-content-between align-items-center"});
      var $smellName = $("<h6>", {class: "ml-2", text: smells[index].name});
      var $button = $("<button>", {class: "btn btn-sm btn-warning mr-2", text: "Detect"});
      
      // event listener to update info once smell is clicked
      $button.click(function() {
        $("#cypher").val(smells[index].query);
        drawSmells();
        $("#smellName").text(smells[index].name);
        $("#smellDescription").text("Description: " + smells[index].description);
        $("#smellSolution").text("Solution: " + smells[index].solution);
      });

      $card.append($smellName, $button);
      $("#smells-list").append($card);
    });
  });

  // -- Show Graph --
  $("#getAll").click(async function () {
    $("#cypher").val("MATCH (n) OPTIONAL MATCH (n)-[r:RELATIONSHIP]->(m) RETURN n, r, m");
    viz.stabilize();
    draw();
  });

  // -- Show Smells --
  $("#smellDetection").click(async function () {
    $("#cypher").val("MATCH (n) OPTIONAL MATCH (n)-[r]->(m) RETURN n, r, m");
    viz.stabilize();
    drawSmells();
  });

  // -- Options --
  $("#save").click(async function () {
    $("#cypher").val("MATCH (n) OPTIONAL MATCH (n)-[r:RELATIONSHIP]->(m) RETURN n, r, m");
    viz.stabilize();
    if ($("#community-color input[type='radio']:checked").val() === 'color') {
      draw();
    } else {
      drawCommunites();
    }
  });

  // -- Filters --
  $("#apply").click(async function () {
    var query = "MATCH (n)  WHERE (";
    if ($("#layers-form input[type='checkbox']:checked").length === 0 || $("#aspect-form input[type='checkbox']:checked").length === 0) {
      /*
      $("#cypher").val("MATCH (n) OPTIONAL MATCH (n)-[r:RELATIONSHIP]->(m) RETURN n, r, m");
      viz.stabilize();
      draw();
      */
      return;
    }
    $("#layers-form input[type='checkbox']:checked").each(function(){
      query += "n.";
      query += ($(this).val());
      query += " OR ";
    });
    query = query.slice(0, query.length - 4);
    query += ") AND ("
    $("#aspect-form input[type='checkbox']:checked").each(function(){
      query += "n.";
      query += ($(this).val());
      query += " OR ";
    });
    query = query.slice(0, query.length - 4);
    query += ") OPTIONAL MATCH (n)-[r]->(m) RETURN n, r";
    console.log(query);
    $("#cypher").val(query);
    viz.stabilize();
    draw();
  });

  $("#reload").click(async function() {
    viz.stabilize();
    var cypher = $("#cypher").val();

    if (cypher.length > 3) {
     draw();
   } else {
    viz.reload();
  }
});

  $("#stabilize").click(function() {
    viz.stabilize();
  });
</script>
</html>