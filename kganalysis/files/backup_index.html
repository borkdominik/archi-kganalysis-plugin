<!DOCTYPE html>
<html>
<head>
    <title>Neovis.js Simple Example</title>
    <style type="text/css">
        html, body {
            font: 16pt arial;
        }

        #viz {
            width: 900px;
            height: 700px;
            border: 1px solid lightgray;
            font: 22pt arial;
        }

    </style>

    <!-- FIXME: load from dist -->
	<script src="https://rawgit.com/neo4j-contrib/neovis.js/2.0.0/dist/neovis.js"></script>

    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script type="text/javascript">
		// define config car
		// instantiate nodevis object
		// draw

		var viz;

		function draw() {
			var config = {
				containerId: "viz",
				serverUrl: "bolt://localhost:7687",
				serverUser: "neo4j",
				serverPassword: "abc",
				labels: {
					Node: { 
						caption: "name"
					}

				}, 
				relationships: {
					"RELATED": {
						"thickness": "weight",
						"caption": false,
						[NeoVis.NEOVIS_ADVANCED_CONFIG]: { 
                			function: { // same as label advance function
                    			title: NeoVis.objectToTitleHtml // putting caption on the title
                				}

					} }
				},
				initialCypher: "MATCH (n)-[r]->(m) RETURN * LIMIT 100",
				visConfig: {
        			edges: {
            			arrows: {
                			to: {enabled: true}
            			}
        			}
        			},
        layout: {
            enabled: true,
            sortMethod: 'directed'
        }	
			};

			//const newConfig = NeoVis.migrateFromOldConfig(oldConfig);

			viz = new NeoVis.default(config);
			viz.render();
			console.log(viz);

		}

		function addConfig() {
			var driver = neo4j.driver(
				'bolt://localhost:7687',
				neo4j.auth.basic('neo4j', 'abc')
			);

			labelConf = [];
		
			var communityCounter = 0;
			var session = driver.session();
			session.run("MATCH (n) RETURN distinct labels(n)[0] as label", {

			})
			.subscribe({
				onKeys: keys => {
					console.log(keys)
				},
				onNext: record => {
					console.log(record.get('label'));
					if (record.get('label')) {
						
						var communityResult;
						/*if(record.get('community'))
							communityResult = $("#community").val();
						else
							communityResult = communityCounter;
						*/
						//TO FIX THIS
						communityResult = $("#community").val();
						
						labelConf[record.get('label')] = {
							"caption": $("#caption").val(),
							"size": $("#size").val(),
							"community": communityResult // Math.floor(Math.random() * 20) + 0  //"#" + ((1<<24)*Math.random() | 0).toString(16)
						};
					}
					communityCounter++;

				},
				onCompleted: () => {
					session.close() // returns a Promise
					driver.close();
					console.log(labelConf);

					console.log(JSON.stringify(labelConf));
					draw(labelConf);
				},
				onError: error => {
					console.log(error)
				}
			});
	}

    </script>
</head>
<body onload="draw()">
<div id="viz"></div>


Cypher query: <textarea rows="4" cols=50 id="cypher"></textarea><br>
<input type="submit" value="Submit" id="reload">
<input type="submit" value="Stabilize" id="stabilize">


</body>

<script>
	$("#reload").click(function() {

		var cypher = $("#cypher").val();

		if (cypher.length > 3) {
			viz.renderWithCypher(cypher);
		} else {
			console.log("reload");
			viz.reload();

		}

	});

	$("#stabilize").click(function() {
		viz.stabilize();
	})

</script>
</html>